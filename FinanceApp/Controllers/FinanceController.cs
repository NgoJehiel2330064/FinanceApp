using Microsoft.AspNetCore.Mvc;
using FinanceApp.Services;

namespace FinanceApp.Controllers;

/// <summary>
/// Controller API REST pour les fonctionnalités financières avancées (IA)
/// </summary>
/// <remarks>
/// Ce controller gère les endpoints liés à l'intelligence artificielle :
/// - Conseils financiers personnalisés
/// - Analyse des habitudes de dépenses
/// - Prédictions budgétaires
/// 
/// [ApiController] : Active les comportements API (validation auto, binding auto, etc.)
/// [Route("api/[controller]")] : Route de base = /api/finance
/// </remarks>
[ApiController]
[Route("api/[controller]")]
public class FinanceController : ControllerBase
{
    private readonly IGeminiService _geminiService;
    private readonly ILogger<FinanceController> _logger;

    /// <summary>
    /// Constructeur avec injection de dépendances
    /// </summary>
    /// <param name="geminiService">Service IA Gemini pour les analyses</param>
    /// <param name="logger">Service de logging</param>
    /// <remarks>
    /// INJECTION DE DÉPENDANCES :
    /// 
    /// Quand une requête HTTP arrive sur /api/finance/advice :
    /// 1. ASP.NET Core identifie le controller : FinanceController
    /// 2. Regarde les paramètres du constructeur : IGeminiService, ILogger
    /// 3. Cherche dans le conteneur DI (configuré dans Program.cs)
    /// 4. Trouve les implémentations enregistrées :
    ///    - IGeminiService ? GeminiService (Scoped)
    ///    - ILogger ? Service de logging intégré (Singleton)
    /// 5. Instancie le controller avec ces dépendances
    /// 6. Appelle la méthode d'action (GetFinancialAdvice)
    /// 7. À la fin de la requête, dispose les services Scoped
    /// </remarks>
    public FinanceController(IGeminiService geminiService, ILogger<FinanceController> logger)
    {
        _geminiService = geminiService;
        _logger = logger;
    }

    /// <summary>
    /// GET /api/finance/advice
    /// Obtient un conseil financier personnalisé basé sur l'analyse IA des transactions
    /// </summary>
    /// <returns>Conseil financier généré par Gemini (15 mots max)</returns>
    /// <remarks>
    /// FLUX COMPLET DE LA DONNÉE (Request ? Database ? IA ? Response) :
    /// 
    /// ???????????????????????????????????????????????????????????????????
    /// ? 1. CLIENT (Frontend React/Postman)                             ?
    /// ?    ? Envoie : GET http://localhost:5000/api/finance/advice     ?
    /// ???????????????????????????????????????????????????????????????????
    ///                       ? HTTP Request
    ///                       ?
    /// ???????????????????????????????????????????????????????????????????
    /// ? 2. KESTREL (Serveur Web ASP.NET Core)                          ?
    /// ?    ? Reçoit la requête HTTP                                     ?
    /// ?    ? Passe au pipeline middleware                               ?
    /// ???????????????????????????????????????????????????????????????????
    ///                       ?
    ///                       ?
    /// ???????????????????????????????????????????????????????????????????
    /// ? 3. MIDDLEWARE PIPELINE (Program.cs)                             ?
    /// ?    ? CORS : Vérifie l'origine (localhost:3000 autorisé)        ?
    /// ?    ? Authorization : Vérifie les permissions (pour l'instant ?) ?
    /// ?    ? Routing : Trouve le controller correspondant              ?
    /// ???????????????????????????????????????????????????????????????????
    ///                       ?
    ///                       ?
    /// ???????????????????????????????????????????????????????????????????
    /// ? 4. DI CONTAINER (Dependency Injection)                          ?
    /// ?    ? Instancie FinanceController                                ?
    /// ?    ? Injecte GeminiService (Scoped - nouvelle instance)        ?
    /// ?    ? Injecte ApplicationDbContext (Scoped)                      ?
    /// ?    ? Injecte ILogger (Singleton)                                ?
    /// ???????????????????????????????????????????????????????????????????
    ///                       ?
    ///                       ?
    /// ???????????????????????????????????????????????????????????????????
    /// ? 5. CONTROLLER (FinanceController.GetFinancialAdvice)            ?
    /// ?    ? Log : "Demande de conseil financier reçue"                ?
    /// ?    ? Appelle : _geminiService.GetFinancialAdvice()             ?
    /// ???????????????????????????????????????????????????????????????????
    ///                       ?
    ///                       ?
    /// ???????????????????????????????????????????????????????????????????
    /// ? 6. GEMINI SERVICE (GetFinancialAdvice)                          ?
    /// ?    ? Appelle : _context.Transactions.ToListAsync()             ?
    /// ???????????????????????????????????????????????????????????????????
    ///                       ?
    ///                       ?
    /// ???????????????????????????????????????????????????????????????????
    /// ? 7. ENTITY FRAMEWORK CORE (ApplicationDbContext)                 ?
    /// ?    ? Génère le SQL : SELECT * FROM "Transactions"              ?
    /// ?    ? Passe à Npgsql                                             ?
    /// ???????????????????????????????????????????????????????????????????
    ///                       ?
    ///                       ?
    /// ???????????????????????????????????????????????????????????????????
    /// ? 8. NPGSQL (Driver PostgreSQL)                                   ?
    /// ?    ? Encode la requête en protocole PostgreSQL                  ?
    /// ?    ? Envoie via TCP/IP à localhost:5432                        ?
    /// ???????????????????????????????????????????????????????????????????
    ///                       ? TCP/IP
    ///                       ?
    /// ???????????????????????????????????????????????????????????????????
    /// ? 9. DOCKER                                                       ?
    /// ?    ? Intercepte le port 5432                                    ?
    /// ?    ? Redirige vers le conteneur postgres_db                    ?
    /// ???????????????????????????????????????????????????????????????????
    ///                       ?
    ///                       ?
    /// ???????????????????????????????????????????????????????????????????
    /// ? 10. POSTGRESQL (Conteneur Docker)                               ?
    /// ?    ? Exécute la requête SQL                                     ?
    /// ?    ? Retourne les lignes de la table "Transactions"            ?
    /// ???????????????????????????????????????????????????????????????????
    ///                       ? Résultats SQL
    ///                       ?
    /// ???????????????????????????????????????????????????????????????????
    /// ? 11. FLUX RETOUR : PostgreSQL ? Docker ? Npgsql ? EF Core       ?
    /// ?    ? EF Core mappe les lignes SQL en objets Transaction        ?
    /// ?    ? Retourne List<Transaction> au GeminiService               ?
    /// ???????????????????????????????????????????????????????????????????
    ///                       ?
    ///                       ?
    /// ???????????????????????????????????????????????????????????????????
    /// ? 12. GEMINI SERVICE (Analyse des données)                        ?
    /// ?    ? Calcule : revenus, dépenses, balance, top catégorie       ?
    /// ?    ? Construit un prompt pour Gemini                            ?
    /// ?    ? Appelle : CallGeminiApiAsync()                             ?
    /// ???????????????????????????????????????????????????????????????????
    ///                       ?
    ///                       ?
    /// ???????????????????????????????????????????????????????????????????
    /// ? 13. APPEL API GEMINI (via HttpClient)                           ?
    /// ?    ? POST https://generativelanguage.googleapis.com/...        ?
    /// ?    ? Body JSON : { contents: [{ parts: [{ text: prompt }] }] } ?
    /// ???????????????????????????????????????????????????????????????????
    ///                       ? HTTPS Request
    ///                       ?
    /// ???????????????????????????????????????????????????????????????????
    /// ? 14. SERVEURS GOOGLE (API Gemini)                                ?
    /// ?    ? Reçoit le prompt                                           ?
    /// ?    ? Exécute le modèle d'IA (gemini-1.5-flash)                 ?
    /// ?    ? Génère un conseil financier (15 mots max)                 ?
    /// ?    ? Retourne JSON : { candidates: [{ content: ... }] }        ?
    /// ???????????????????????????????????????????????????????????????????
    ///                       ? HTTPS Response
    ///                       ?
    /// ???????????????????????????????????????????????????????????????????
    /// ? 15. GEMINI SERVICE (Parse la réponse)                           ?
    /// ?    ? Parse le JSON                                              ?
    /// ?    ? Extrait le texte généré                                    ?
    /// ?    ? Retourne le conseil au Controller                         ?
    /// ???????????????????????????????????????????????????????????????????
    ///                       ?
    ///                       ?
    /// ???????????????????????????????????????????????????????????????????
    /// ? 16. CONTROLLER (GetFinancialAdvice)                             ?
    /// ?    ? Reçoit le conseil du GeminiService                         ?
    /// ?    ? Retourne : Ok(new { advice = "..." })                     ?
    /// ???????????????????????????????????????????????????????????????????
    ///                       ?
    ///                       ?
    /// ???????????????????????????????????????????????????????????????????
    /// ? 17. MIDDLEWARE PIPELINE (Remontée)                              ?
    /// ?    ? Sérialise l'objet en JSON                                  ?
    /// ?    ? Ajoute les headers CORS                                    ?
    /// ?    ? Génère la réponse HTTP 200 OK                             ?
    /// ???????????????????????????????????????????????????????????????????
    ///                       ? HTTP Response
    ///                       ?
    /// ???????????????????????????????????????????????????????????????????
    /// ? 18. CLIENT (Frontend React/Postman)                             ?
    /// ?    ? Reçoit : { "advice": "Réduisez vos dépenses..." }        ?
    /// ?    ? Affiche le conseil à l'utilisateur                        ?
    /// ???????????????????????????????????????????????????????????????????
    /// 
    /// EXEMPLE DE RÉPONSE :
    /// {
    ///   "advice": "Réduisez vos dépenses en alimentation de 20% pour économiser 100€ mensuels."
    /// }
    /// 
    /// CODES HTTP POSSIBLES :
    /// - 200 OK : Conseil généré avec succès
    /// - 500 Internal Server Error : Erreur serveur (base de données, API Gemini, etc.)
    /// </remarks>
    [HttpGet("advice")]
    public async Task<ActionResult<object>> GetFinancialAdvice()
    {
        try
        {
            // Log de la requête entrante
            _logger.LogInformation("Demande de conseil financier reçue");

            // ================================================================
            // APPEL DU SERVICE GEMINI
            // ================================================================
            // GetFinancialAdvice() déclenche tout le flux décrit ci-dessus :
            // 1. Récupération des transactions depuis PostgreSQL
            // 2. Analyse des données financières
            // 3. Construction du prompt
            // 4. Appel à l'API Gemini
            // 5. Parsing de la réponse
            // 6. Retour du conseil
            var advice = await _geminiService.GetFinancialAdvice();

            _logger.LogInformation("Conseil généré : {Advice}", advice);

            // ================================================================
            // RETOUR DE LA RÉPONSE
            // ================================================================
            // Ok() : Retourne HTTP 200 avec un objet JSON
            // L'objet anonyme { advice = "..." } est automatiquement sérialisé en JSON
            // 
            // Réponse HTTP :
            // Status: 200 OK
            // Content-Type: application/json
            // Body: { "advice": "texte du conseil..." }
            return Ok(new { advice });
        }
        catch (Exception ex)
        {
            // En cas d'erreur (base de données inaccessible, API Gemini down, etc.)
            _logger.LogError(ex, "Erreur lors de la génération du conseil financier");

            // StatusCode(500) : Retourne HTTP 500 Internal Server Error
            // Avec un message d'erreur pour le frontend
            return StatusCode(500, new 
            { 
                error = "Impossible de générer un conseil pour le moment.",
                details = ex.Message 
            });
        }
    }

    /// <summary>
    /// POST /api/finance/suggest-category
    /// Suggère une catégorie pour une transaction basée sur sa description et son montant
    /// </summary>
    /// <param name="request">Données de la transaction (description + montant)</param>
    /// <returns>Nom de la catégorie suggérée par l'IA</returns>
    /// <remarks>
    /// EXEMPLE DE REQUÊTE :
    /// POST /api/finance/suggest-category
    /// {
    ///   "description": "Courses Lidl",
    ///   "amount": 45.80
    /// }
    /// 
    /// EXEMPLE DE RÉPONSE :
    /// {
    ///   "category": "Alimentation"
    /// }
    /// 
    /// CATÉGORIES POSSIBLES :
    /// - Alimentation
    /// - Transport
    /// - Logement
    /// - Loisirs
    /// - Santé
    /// - Éducation
    /// - Vêtements
    /// - Technologie
    /// - Services
    /// - Autres
    /// </remarks>
    [HttpPost("suggest-category")]
    public async Task<ActionResult<object>> SuggestCategory([FromBody] CategorySuggestionRequest request)
    {
        try
        {
            _logger.LogInformation(
                "Demande de suggestion de catégorie : '{Description}', {Amount}€",
                request.Description,
                request.Amount
            );

            // Validation
            if (string.IsNullOrWhiteSpace(request.Description))
            {
                return BadRequest(new { error = "La description est requise" });
            }

            if (request.Amount <= 0)
            {
                return BadRequest(new { error = "Le montant doit être positif" });
            }

            // Appel au service IA
            var category = await _geminiService.SuggestCategoryAsync(request.Description, request.Amount);

            _logger.LogInformation("Catégorie suggérée : {Category}", category);

            return Ok(new { category });
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Erreur lors de la suggestion de catégorie");
            return StatusCode(500, new 
            { 
                error = "Impossible de suggérer une catégorie pour le moment.",
                details = ex.Message 
            });
        }
    }

    /// <summary>
    /// GET /api/finance/summary
    /// Génère un résumé financier personnalisé pour une période donnée
    /// </summary>
    /// <param name="startDate">Date de début (format ISO 8601)</param>
    /// <param name="endDate">Date de fin (format ISO 8601)</param>
    /// <returns>Résumé financier généré par l'IA</returns>
    /// <remarks>
    /// EXEMPLE DE REQUÊTE :
    /// GET /api/finance/summary?startDate=2025-01-01&endDate=2025-01-31
    /// 
    /// EXEMPLE DE RÉPONSE :
    /// {
    ///   "summary": "En janvier, vous avez économisé 15% de vos revenus. Vos dépenses en Alimentation sont sous contrôle. Continuez ainsi !"
    /// }
    /// 
    /// UTILITÉ :
    /// - Rapport mensuel automatique
    /// - Dashboard avec KPIs
    /// - Analyse de période personnalisée
    /// </remarks>
    [HttpGet("summary")]
    public async Task<ActionResult<object>> GetFinancialSummary(
        [FromQuery] DateTime startDate,
        [FromQuery] DateTime endDate)
    {
        try
        {
            _logger.LogInformation(
                "Demande de résumé financier : {StartDate} - {EndDate}",
                startDate,
                endDate
            );

            // Validation
            if (startDate >= endDate)
            {
                return BadRequest(new { error = "La date de début doit être antérieure à la date de fin" });
            }

            if (endDate > DateTime.Now)
            {
                return BadRequest(new { error = "La date de fin ne peut pas être dans le futur" });
            }

            // Appel au service IA
            var summary = await _geminiService.GenerateFinancialSummaryAsync(startDate, endDate);

            _logger.LogInformation("Résumé généré : {Summary}", summary);

            return Ok(new { summary });
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Erreur lors de la génération du résumé financier");
            return StatusCode(500, new 
            { 
                error = "Impossible de générer un résumé pour le moment.",
                details = ex.Message 
            });
        }
    }

    /// <summary>
    /// GET /api/finance/anomalies
    /// Détecte les anomalies dans les transactions (dépenses inhabituelles)
    /// </summary>
    /// <returns>Liste des anomalies détectées</returns>
    /// <remarks>
    /// EXEMPLE DE RÉPONSE :
    /// {
    ///   "anomalies": [
    ///     "Dépense inhabituelle : 450€ en Loisirs le 15/02 (moyenne: 80€, écart: +462%)",
    ///     "Pic de dépenses Alimentation : +40% par rapport au mois dernier"
    ///   ]
    /// }
    /// 
    /// ALGORITHME :
    /// - Calcule la moyenne par catégorie
    /// - Détecte les écarts > 50% de la moyenne
    /// - Enrichit avec des alertes générées par Gemini
    /// 
    /// UTILITÉ :
    /// - Détection de fraude
    /// - Alertes automatiques
    /// - Suivi des habitudes de dépenses
    /// </remarks>
    [HttpGet("anomalies")]
    public async Task<ActionResult<object>> DetectAnomalies()
    {
        try
        {
            _logger.LogInformation("Demande de détection d'anomalies");

            // Appel au service IA
            var anomalies = await _geminiService.DetectAnomaliesAsync();

            _logger.LogInformation("Détection terminée : {Count} anomalie(s)", anomalies.Count);

            return Ok(new { anomalies });
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Erreur lors de la détection d'anomalies");
            return StatusCode(500, new 
            { 
                error = "Impossible de détecter les anomalies pour le moment.",
                details = ex.Message 
            });
        }
    }

    /// <summary>
    /// GET /api/finance/predict
    /// Prédit le budget futur basé sur les tendances historiques
    /// </summary>
    /// <param name="monthsAhead">Nombre de mois à prédire (1-12)</param>
    /// <returns>Prédiction budgétaire générée par l'IA</returns>
    /// <remarks>
    /// EXEMPLE DE REQUÊTE :
    /// GET /api/finance/predict?monthsAhead=3
    /// 
    /// EXEMPLE DE RÉPONSE :
    /// {
    ///   "prediction": "Basé sur vos habitudes, vous économiserez environ 600€ dans 3 mois. Maintenez vos efforts d'épargne !"
    /// }
    /// 
    /// ALGORITHME :
    /// - Analyse des 3 derniers mois
    /// - Calcul des moyennes et tendances
    /// - Prédiction par Gemini avec contexte
    /// 
    /// UTILITÉ :
    /// - Planification budgétaire
    /// - Objectifs d'épargne
    /// - Motivation financière
    /// </remarks>
    [HttpGet("predict")]
    public async Task<ActionResult<object>> PredictBudget([FromQuery] int monthsAhead = 3)
    {
        try
        {
            _logger.LogInformation("Demande de prédiction de budget : {Months} mois", monthsAhead);

            // Validation
            if (monthsAhead <= 0 || monthsAhead > 12)
            {
                return BadRequest(new { error = "Le nombre de mois doit être entre 1 et 12" });
            }

            // Appel au service IA
            var prediction = await _geminiService.PredictBudgetAsync(monthsAhead);

            _logger.LogInformation("Prédiction générée : {Prediction}", prediction);

            return Ok(new { prediction });
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Erreur lors de la prédiction de budget");
            return StatusCode(500, new 
            { 
                error = "Impossible de générer une prédiction pour le moment.",
                details = ex.Message 
            });
        }
    }

    /// <summary>
    /// GET /api/finance/portfolio-insights
    /// Analyse le patrimoine global et génère des insights stratégiques personnalisés
    /// </summary>
    /// <returns>3 insights patrimoniaux générés par l'IA</returns>
    /// <remarks>
    /// EXEMPLE DE REQUÊTE :
    /// GET /api/finance/portfolio-insights
    /// 
    /// EXEMPLE DE RÉPONSE :
    /// {
    ///   "insights": [
    ///     "Votre patrimoine est fortement concentré en immobilier (70%), ce qui limite la liquidité et la diversification.",
    ///     "Vos revenus mensuels (3200 CAD) représentent seulement 0.7% de la valeur de vos actifs, un ratio faible.",
    ///     "Seulement 20% de votre patrimoine est investi dans des actifs productifs (investissements)."
    ///   ]
    /// }
    /// 
    /// ALGORITHME :
    /// 1. Récupère tous les assets et transactions
    /// 2. Calcule :
    ///    - Valeur totale et répartition par type
    ///    - Revenus/dépenses mensuels moyens
    ///    - Ratio revenus/patrimoine
    ///    - % d'assets productifs
    /// 3. Génère 3 insights via Gemini
    /// 
    /// UTILITÉ :
    /// - Dashboard patrimonial
    /// - Analyse de diversification
    /// - Conseils stratégiques
    /// - Suivi de la structure du patrimoine
    /// </remarks>
    [HttpGet("portfolio-insights")]
    public async Task<ActionResult<object>> GetPortfolioInsights()
    {
        try
        {
            _logger.LogInformation("Demande d'insights patrimoniaux");

            // Appel au service IA
            var insights = await _geminiService.GetPortfolioInsightsAsync();

            _logger.LogInformation("Insights générés : {Count} insight(s)", insights.Count);

            return Ok(new { insights });
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Erreur lors de la génération d'insights patrimoniaux");
            return StatusCode(500, new 
            { 
                error = "Impossible de générer des insights pour le moment.",
                details = ex.Message 
            });
        }
    }
}

/// <summary>
/// DTO pour la requête de suggestion de catégorie
/// </summary>
public class CategorySuggestionRequest
{
    public string Description { get; set; } = string.Empty;
    public decimal Amount { get; set; }
}
